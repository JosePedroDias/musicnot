<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <title>piano</title>

        <style>
            body {
                font-family: sans-serif;
            }
        </style>

        <script src="generator.js"></script>
    </head>

    <body>
        <script>
            var tempo = 60;
            var time = [4, 4];
            var mode = 'string'; // square triangle sawtooth sine string

            var play = function(note) {
                var f = computeFreq(note);
                return (mode === 'string' ? genString(f) : genNote(f, mode));
            };

            var playN = function(notes) {
                var playing = notes.map(play);
                return function() {
                    playing.forEach(function(p) {
                        p();
                    });
                };
            };

            var song = [
                {dur:4, notes:['G3', 'B3', 'D4', 'G4']},
                {dur:4, notes:['G3', 'B3', 'D4', 'G4']},
                {dur:4, notes:['F#3', 'A3', 'D4']},
                {dur:4, notes:['F#3', 'A3', 'D4']},
                {dur:2, notes:['G2']},
                {dur:2, notes:['G1']},
                {dur:2, notes:['G2']},
                {dur:2, notes:['G1']}
            ];

            var dur;
            var timer, playing;

            var onTick = function() {
                if (dur) {
                    --dur;
                    return;
                }

                var o = song.shift();

                if (!o) {
                    if (playing) {
                        playing();
                    }
                    playing = undefined;
                    console.log('all done');
                    return clearInterval(timer);
                }

                var note = o.notes;
                dur = o.dur;

                if (playing) {
                    playing();
                    playing = undefined;
                }

                console.log(note);
                playing = playN(note);
            };

            timer = setInterval(onTick, 60000/tempo/time[1]); // https://en.m.wikipedia.org/wiki/Time_signature
        </script>
    </body>
</html>
