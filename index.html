<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">

        <title>inspect</title>

        <style>
            body {
                font-family: sans-serif;
            }
        </style>
    </head>

	<body>
        <ul>
			<li><a href="?Happy_Birthday.song">Happy Birthday</a></li>
            <li><a href="?Let_It_Be.song">Let It Be</a></li>
            <li><a href="?Super_Mario_Theme.song">Super Mario Theme</a></li>
        </ul>

		<script src="generator.js"></script>

		<script>
			var playSong = function(o) {
				var tempo = 60;
				var time = [4, 4];
				var mode = 'string'; // square triangle sawtooth sine string
                var cursor = 0;

				var play = function (note) {
					var f = computeFreq(note);
					return (mode === 'string' ? genString(f) : genNote(f, mode));
				};

				var playN = function (notes) {
					var playing = notes.map(play);
					return function () {
						playing.forEach(function (p) {
							p();
						});
					};
				};


                // TODO TEMP HACK -> selects only first part and first voice, joining its measures
                var song = o.parts[0];

                if ('time' in song[0]) {
                    time = song[0].time;
                    console.log('time:', time);
                }
                if ('tempo' in song[0]) {
                    tempo = song[0].tempo;
                    console.log('tempo:', tempo);
                }

                song = song.map(function(measure) {
                    return measure.voices[0];
                });

                var song2 = [];
                song.forEach(function(a) {
                    a.forEach(function(b) {
                        song2.push(b);
                    });
                });
                song = song2;
                //console.log(song);



				var dur;
				var timer, playing;

				var onTick = function () {
					if (dur) {
						--dur;
                        ++cursor;
						return;
					}

					var o = song.shift();

                    if (!o) {
                        if (playing) {
                            playing();
                        }
                        playing = undefined;
                        console.log('all done');
                        return clearInterval(timer);
                    }

                    var isChorus = (o instanceof Array);
                    var isRest = !isChorus && !('note' in o);

					var note = isChorus ? o.map(function(n) { return n.note; })  : o.note;
					dur = isChorus ? o[0].dur : o.dur;

					if (playing) {
						playing();
						playing = undefined;
					}

                    if (isRest) {
                        console.log(cursor, 'rest');
                    }
                    else {
                        console.log(cursor, (isChorus ? 'chorus' : 'note'), note);
                    }

					playing = isRest ? undefined : (isChorus ? playN(note) : play(note));

                    ++cursor;
				};

				timer = setInterval(onTick, 30000 / tempo / time[1]); // https://en.m.wikipedia.org/wiki/Time_signature
			};




            var inFile = location.search.substring(1);

			var ajax = function(o) {
				var xhr = new XMLHttpRequest();
				xhr.open(o.verb || 'GET', o.uri, true);
				var cbInner = function() {
					if (xhr.readyState === 4 && xhr.status > 199 && xhr.status < 300) {
						return o.cb(null, JSON.parse(xhr.response));
					}
					o.cb('error requesting ' + o.uri);
				};
				xhr.onload  = cbInner;
				xhr.onerror = cbInner;
				xhr.send(null);
			};

			ajax({
				uri: inFile,
				cb: function(err, _song) {
                    if (err) { return console.error(err); }
					window.s = _song;
					playSong(_song);
				}
			});
		</script>

	</body>	
</html>
